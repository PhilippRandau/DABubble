<header>
    <div class="header_content">
        <span>Thread</span>
        <span># Entwicklerteam</span>
        <div>
            <img (click)="closeThread(false)" src="/assets/img/icons/close.png" alt="">
        </div>
    </div>
</header>


<div *ngIf="fsDataThreadService.thread_open" class="thread_content">
    <div class="message_div "
        [class.row_reverse]="fsDataThreadService.current_chat_data?.user_Sender_ID == authenticationService.userData.uid">


        <div [class.show_edit_comment]="edit_comment && edit_comment_index == -1  "
            class="edit_comment" (click)="openEditComment(-1)">
            <div class="menu_button" (click)="openEditMessage()" (click)="stopPropagation($event)">
                <span>Nachricht bearbeiten</span>
            </div>
            <div class="menu_button" (click)="openDeleteMessage()" (click)="stopPropagation($event)">
                <span>Nachricht löschen</span>
            </div>
        </div>

        <emoji-mart [class.d_block]="emojiPicker_open && picker_index == -1" class="emoji_picker"
        (click)="stopPropagation($event) " (emojiClick)="addEmojiInDirectMessage($event, fsDataThreadService.direct_chat_index)"></emoji-mart>

        <div *ngIf="fsDataThreadService.current_chat_data.user_Sender_ID != authenticationService.userData.uid"
            (click)="openEmojiPicker(-1)" (click)="stopPropagation($event)" class="reaction_emojy">
            <div class="emojy"><img src="/assets/img/icons/add_reaction.png" alt=""></div>
        </div>

        <div *ngIf="fsDataThreadService.current_chat_data.user_Sender_ID == authenticationService.userData.uid"
            (click)="openEmojiPicker(-1)" (click)="stopPropagation($event)" class="reaction_emojy_user">
            <div class="emojy">
                <img src="/assets/img/icons/add_reaction.png" alt="">
            </div>
            <div class="emojy" (click)="openEditCommentMenu(-1)" (click)="stopPropagation($event)">
                <img src="/assets/img/icons/more_vert.png">
            </div>
        </div>


        <div class="bottom_line" *ngIf="fsDataThreadService.comments?.length > 0">
            <div>
                <span>{{fsDataThreadService.comments.length}} Antwort</span>
                <div *ngIf="fsDataThreadService.comments?.length > 1">en</div>
            </div>

            <div class="line"></div>
        </div>
        <img class="avatar_img" [src]="getImageUrl(fsDataThreadService.current_chat_data?.user_Sender_ID)">
        <div class="message_sub">
            <div class="user_time">
                <span>{{getUserName(fsDataThreadService.current_chat_data.user_Sender_ID)}}</span>
                <span>{{fsDataThreadService.getTimeSince(fsDataThreadService.current_chat_data.created_At.seconds)}}</span>
            </div>
            <div class="message"
                [class.message_user]="fsDataThreadService.current_chat_data?.user_Sender_ID == authenticationService.userData.uid">
                {{fsDataThreadService.current_message}}</div>
            <div class="emoji_main">
                <div *ngFor="let item of 0" class="emoji_count" matTooltip="{{react_user}} hat reagiert">
                    <ngx-emoji class="center" [emoji]="" size="24"></ngx-emoji>
                    <span></span>
                </div>
            </div>

            <div class="emoji_main">
                <div *ngFor="let emoji of fsDataThreadService.current_chat_data.emoji_data; let j = index" class="emoji_count"  (mouseenter)="showReactUsers(-1, j)" (mouseleave)="closeShowReactUsers(-1, j)"
                    (click)="addOrRemoveEmojisOnDirectChatMessage(fsDataThreadService.direct_chat_index , j)">
                    <div class="react_user" 
                        [class.show_react_user]="comment_index == -1 && emoji_index == j && hovered_emoji">
                        <ngx-emoji class="center" [emoji]="fsDataThreadService.current_chat_data.emoji_data[j].emoji"
                            size="24"></ngx-emoji>
                        <span>{{fsDataThreadService.current_chat_data.emoji_data[j]?.react_users?.join(' und ')}}</span>
                        <div *ngIf="fsDataThreadService.current_chat_data.emoji_data[j]?.react_users?.length < 2">hat
                            reagiert</div>
                        <div *ngIf="fsDataThreadService.current_chat_data.emoji_data[j]?.react_users?.length > 1">haben
                            reagiert</div>
                    </div>
                    <ngx-emoji class="center" [emoji]="fsDataThreadService.current_chat_data.emoji_data[j].emoji"
                        size="24"></ngx-emoji>
                    <span>{{fsDataThreadService.current_chat_data.emoji_data[j].count}}</span>
                </div>
            </div>
        </div>  
    </div>


    <div class="comment_div"
        [class.row_reverse]="getUserName(fsDataThreadService.comments[i]?.uid) == authenticationService.userData.user_name"
        *ngFor="let comment of fsDataThreadService.fake_array; let i = index">
        <div [class.show_edit_comment]="edit_comment && getUserName(fsDataThreadService.comments[i].uid) == authenticationService.userData.user_name && edit_comment_index == i"
            class="edit_comment" (click)="openEditComment(i)">
            <div class="menu_button" (click)="openEditComment(i)" (click)="stopPropagation($event)">
                <span>Nachricht bearbeiten</span>
            </div>
            <div class="menu_button" (click)="openDeleteComment(i)" (click)="stopPropagation($event)">
                <span>Nachricht löschen</span>
            </div>
        </div>
        <emoji-mart [class.d_block]="emojiPicker_open && picker_index == i" class="emoji_picker"
            (click)="stopPropagation($event) " (emojiClick)="addEmojiInThread($event, i)"></emoji-mart>
        <div *ngIf="getUserName(fsDataThreadService.comments[i].uid) != authenticationService.userData.user_name"
            (click)="openEmojiPicker(i)" (click)="stopPropagation($event)" class="reaction_emojy">
            <div class="emojy"><img src="/assets/img/icons/add_reaction.png" alt=""></div>
        </div>
        <div *ngIf="getUserName(fsDataThreadService.comments[i].uid) == authenticationService.userData.user_name"
            (click)="openEmojiPicker(i)" (click)="stopPropagation($event)" class="reaction_emojy_user">
            <div class="emojy">
                <img src="/assets/img/icons/add_reaction.png" alt="">
            </div>
            <div class="emojy" (click)="openEditCommentMenu(i)" (click)="stopPropagation($event)">
                <img src="/assets/img/icons/more_vert.png">
            </div>
        </div>
        <img class="avatar_img" [src]="getImageUrl(fsDataThreadService.comments[i].uid)">
        <div class="message_sub">
            <div class="user_time">
                <span
                    (click)="openProfile(fsDataThreadService.comments[i].uid)">{{getUserName(fsDataThreadService.comments[i].uid)}}</span>
                <span>{{fsDataThreadService.getTimeSince(fsDataThreadService.comments[i].time.seconds)}}</span>
            </div>
            <div *ngIf="fsDataThreadService.comments[i].comment.length > 0" class="message"
                [class.message_user]="getUserName(fsDataThreadService.comments[i].uid) == authenticationService.userData.user_name">
                {{fsDataThreadService.comments[i].comment}}
                <div *ngIf="fsDataThreadService.comments[i].text_edited">(bearbeitet)</div>
            </div>
            
            <div class="uploaded_main">
                <div *ngFor="let file of fsDataThreadService.comments[i].uploaded_files.file_name; let k = index" class="upload_content" (click)="uploadService.downloadFile(fsDataThreadService.comments[i].uploaded_files.download_link[k])" style="cursor: pointer;">
                    <div>{{fsDataThreadService.comments[i].uploaded_files.file_name[k]}}</div>
                    <div class="delete_file" *ngIf="fsDataThreadService.comments[i].uid == authenticationService.userData.uid">
                        <img (click)="uploadService.deleteSelectedFile(fsDataThreadService.comments[i].uploaded_files.file_name[k], i, k)" src="/assets/img/icons/close.png" (click)="stopPropagation($event)">
                    </div>
                </div>
            </div>

            <div class="emoji_main">
                <div *ngFor="let emoji of fsDataThreadService.comments[i].emoji_data; let j = index" class="emoji_count"  (mouseenter)="showReactUsers(i, j)" (mouseleave)="closeShowReactUsers(i, j)"
                    (click)="addOrRemoveEmojIinThread(i, j)">
                    <div class="react_user" 
                        [class.show_react_user]="comment_index == i && emoji_index == j && hovered_emoji">
                        <ngx-emoji class="center" [emoji]="fsDataThreadService.comments[i].emoji_data[j].emoji"
                            size="24"></ngx-emoji>
                        <span>{{fsDataThreadService.comments[i].emoji_data[j]?.react_users?.join(' und ')}}</span>
                        <div *ngIf="fsDataThreadService.comments[i].emoji_data[j]?.react_users?.length < 2">hat
                            reagiert</div>
                        <div *ngIf="fsDataThreadService.comments[i].emoji_data[j]?.react_users?.length > 1">haben
                            reagiert</div>
                    </div>
                    <ngx-emoji class="center" [emoji]="fsDataThreadService.comments[i].emoji_data[j].emoji"
                        size="24"></ngx-emoji>
                    <span>{{fsDataThreadService.comments[i].emoji_data[j].count}}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="upload_main">
        <div *ngFor="let file of uploadService.upload_array.file_name; let i = index" class="upload_content">
            <div style="z-index: 1;" >{{uploadService.upload_array.file_name[i]}}</div>
            <div class="progress_load" [style.width.%]="uploadService.uploadProgressArray[i]"></div>
            <div class="delete_file">
                <img (click)="uploadService.removeFile(i)" src="/assets/img/icons/close.png" alt="">
            </div>
        </div>
    </div>

    <!-----------------------------------------------------------------Textarea----------------------------------------------------------------------------------------->

    <div class="type_message">
        <div [class.show_edit_comment]="open_attachment_menu" class="edit_comment">
            <input id="fileInput" type="file" (change)="uploadService.onFileSelected($event)">
            <label class="menu_button" for="fileInput">Datei anhängen</label>
        </div>
        <div class="at_user_div" *ngIf="open_users">
            <div>
                <div class="user" *ngFor="let user of authenticationService.all_users; let i = index"
                    (click)="addUserToTextarea(i)">
                    <img class="user_img" [src]="authenticationService.all_users[i].avatar">
                    <div>{{authenticationService.all_users[i].user_name}}</div>
                </div>
            </div>

        </div>
        <div class="z_index">
            <emoji-mart [class.d_block]="emojiPicker_open && picker_index == -2" class="emoji_picker"
                (emojiClick)="addEmojitoTextarea($event)"></emoji-mart>
        </div>
        <textarea #messageTextarea type="text" [(ngModel)]="comment_value" placeholder="Antworten..."></textarea>
        <div class="icons_main">
            <div class="icons">
                <div class="plus" (click)="openAttachmentMenu()" (click)="stopPropagation($event)">
                    <div class="hover"><img src="/assets/img/icons/add.png" alt=""></div>
                </div>
                <div class="hover"><img src="/assets/img/icons/sentiment_satisfied.png" (click)="openEmojiPicker(-2)"
                        (click)="stopPropagation($event)"></div>
                <div class="hover"><img src="/assets/img/icons/alternate_email.png" (click)="openUsers()"
                        (click)="stopPropagation($event)"></div>
            </div>
        </div>
        <img [class.inactive]="comment_value.length < 1 && uploadService.upload_array.file_name.length == 0" class="send_button" src="/assets/img/icons/send (1).png" alt=""
            (click)="postComment()">
    </div>

</div>